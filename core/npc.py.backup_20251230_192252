import pygame
import random
from core.camera import camera
from core.animated_sprite import AnimatedSprite, SimpleAnimatedSprite
from core.collision import CollisionBox

class NPC(pygame.sprite.Sprite):
    """Base class untuk NPC (Dosen) dengan animated sprite support"""

    def __init__(self, name, x, y, sprite_config, dialogue_lines):
        """
        Args:
            name: Nama NPC
            x, y: Posisi di map
            sprite_config: Dict config untuk sprite
                Format 1 (Aseprite): {
                    'type': 'aseprite',
                    'spritesheet': 'path/to/sprite.png',
                    'json': 'path/to/sprite.json'  # optional
                }
                Format 2 (Simple strip): {
                    'type': 'simple',
                    'sprite': 'path/to/sprite.png',
                    'frame_width': 48,
                    'frame_height': 48,
                    'num_frames': 4
                }
                Format 3 (Fallback): {
                    'type': 'fallback',
                    'color': (100, 100, 200),  # optional
                    'size': (48, 48)  # optional
                }
            dialogue_lines: List dialog
        """
        super().__init__()
        self.name = name
        self.x = x
        self.y = y
        self.dialogue_lines = dialogue_lines

        # Load sprite berdasarkan config
        self._load_sprite(sprite_config)

        # Setup collision box
        # Default: slightly smaller than sprite untuk better feel
        sprite_rect = self.animated_sprite.get_rect()
        self.collision_box = CollisionBox(
            0, 0,  # offset dari sprite position
            sprite_rect.width * 0.8,  # 80% dari sprite width
            sprite_rect.height * 0.8,  # 80% dari sprite height
            shape="rect"
        )
        # Center collision box
        self.collision_box.offset_x = sprite_rect.width * 0.1
        self.collision_box.offset_y = sprite_rect.height * 0.1

        # Interaction range
        self.interaction_range = 80

    def _load_sprite(self, config):
        """Load sprite berdasarkan config"""
        sprite_type = config.get('type', 'fallback')

        if sprite_type == 'aseprite':
            self.animated_sprite = AnimatedSprite(
                spritesheet_path=config['spritesheet'],
                json_path=config.get('json'),
                x=self.x,
                y=self.y,
                fallback_color=config.get('color', (100, 100, 200))
            )

        elif sprite_type == 'simple':
            self.animated_sprite = SimpleAnimatedSprite(
                sprite_path=config['sprite'],
                frame_width=config['frame_width'],
                frame_height=config['frame_height'],
                num_frames=config['num_frames'],
                frame_duration=config.get('frame_duration', 100),
                x=self.x,
                y=self.y,
                fallback_color=config.get('color', (100, 100, 200))
            )

        else:  # fallback
            size = config.get('size', (48, 48))
            color = config.get('color', (100, 100, 200))
            self.animated_sprite = SimpleAnimatedSprite(
                sprite_path='__nonexistent__.png',  # Force fallback
                frame_width=size[0],
                frame_height=size[1],
                num_frames=1,
                x=self.x,
                y=self.y,
                fallback_color=color
            )


    def update(self, dt=16):
        """Update NPC (animation, dll)"""
        # Update position untuk animated sprite
        self.animated_sprite.x = self.x
        self.animated_sprite.y = self.y

        # Update animation
        self.animated_sprite.update(dt)

    def is_in_range(self, player):
        """Cek apakah player dalam jangkauan interaksi"""
        dx = self.x - player.x
        dy = self.y - player.y
        distance = (dx**2 + dy**2)**0.5
        return distance <= self.interaction_range

    def get_random_dialogue(self):
        """Ambil dialog random dari list"""
        return random.choice(self.dialogue_lines)

    def draw(self, screen):
        """Render NPC ke layar"""
        self.animated_sprite.draw(screen)

    def draw_indicator(self, screen, player):
        """Tampilkan indikator jika player dalam range"""
        if self.is_in_range(player):
            # Gambar tanda seru di atas NPC
            font = pygame.font.Font(None, 36)
            text = font.render("!", True, (255, 255, 0))
            screen.blit(text, (self.x - camera.x + 16, self.y - camera.y - 30))

    def draw_collision_debug(self, screen):
        """Draw collision box untuk debugging"""
        self.collision_box.draw_debug(screen, self.x, self.y, camera)


class NPCManager:
    """Manager untuk mengelola semua NPC"""

    def __init__(self):
        self.npcs = []
        self.debug_collision = False  # Toggle untuk debug collision

    def add_npc(self, npc):
        """Tambah NPC ke manager"""
        self.npcs.append(npc)

    def update_all(self, dt=16):
        """Update semua NPC"""
        for npc in self.npcs:
            npc.update(dt)

    def get_nearby_npc(self, player):
        """Cari NPC terdekat yang dalam range"""
        for npc in self.npcs:
            if npc.is_in_range(player):
                return npc
        return None

    def draw_all(self, screen, player):
        """Render semua NPC dan indikator"""
        for npc in self.npcs:
            npc.draw(screen)
            npc.draw_indicator(screen, player)

            # Debug collision (jika enabled)
            if self.debug_collision:
                npc.draw_collision_debug(screen)

    def toggle_debug(self):
        """Toggle collision debug visualization"""
        self.debug_collision = not self.debug_collision
        status = "ON" if self.debug_collision else "OFF"
        print(f"ðŸ” NPC Collision Debug: {status}")


# Template dialog untuk berbagai dosen
DOSEN_DIALOGUES = {
    "pemrograman": [
        "Kerjakan tugas coding tentang algoritma sorting!",
        "Buat program kalkulator sederhana sebagai tugas!",
        "Debug code ini dan temukan errornya!",
        "Implementasikan struktur data linked list!",
        "Optimasi kode yang telah kamu buat!"
    ],
    "database": [
        "Buat ERD untuk sistem perpustakaan!",
        "Tulis query SQL untuk join 3 tabel!",
        "Normalisasi database sampai 3NF!",
        "Design schema untuk e-commerce!",
        "Optimasi query yang lambat ini!"
    ],
    "jaringan": [
        "Konfigurasi router untuk subnet ini!",
        "Analisis traffic jaringan dengan Wireshark!",
        "Setup VPN untuk kantor cabang!",
        "Troubleshoot masalah koneksi ini!",
        "Design topologi jaringan untuk kampus!"
    ],
    "matematika": [
        "Selesaikan integral parsial ini!",
        "Hitung determinan matriks 4x4!",
        "Buktikan teorema ini dengan induksi!",
        "Optimasi fungsi dengan turunan!",
        "Selesaikan sistem persamaan linear!"
    ],
    "umum": [
        "Kerjakan tugas tepat waktu ya!",
        "Baca materi untuk pertemuan berikutnya!",
        "Jangan lupa kumpulkan laporan!",
        "Pelajari konsep yang sudah dijelaskan!",
        "Latihan soal-soal di buku!"
    ]
}


def create_sample_npcs():
    """
    Fungsi helper untuk membuat contoh NPC dosen

    â­ SESUAIKAN POSISI X dan Y DENGAN MAP ANDA! â­
    â­ SESUAIKAN SPRITE CONFIG DENGAN FILE SPRITE ANDA! â­
    """
    npcs = []

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â­â­â­ CONTOH BERBAGAI KONFIGURASI SPRITE â­â­â­
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # CONTOH 1: NPC dengan Aseprite animated sprite
    npc1_sprite_config = {
        'type': 'aseprite',
        'spritesheet': 'sprites/dosen1.png',  # Export dari Aseprite
        'json': 'sprites/dosen1.json'  # Export JSON dari Aseprite
        # Jika tidak ada sprite, akan fallback ke kotak biru
    }

    npc1 = NPC(
        name="Prof. Budi",
        x=250,
        y=150,
        sprite_config=npc1_sprite_config,
        dialogue_lines=DOSEN_DIALOGUES["pemrograman"]
    )
    npcs.append(npc1)

    # CONTOH 2: NPC dengan simple sprite strip
    npc2_sprite_config = {
        'type': 'simple',
        'sprite': 'sprites/dosen2.png',  # Sprite strip horizontal
        'frame_width': 48,  # Lebar setiap frame
        'frame_height': 48,  # Tinggi setiap frame
        'num_frames': 4,  # Jumlah frame dalam strip
        'frame_duration': 150  # Durasi setiap frame (ms)
    }

    npc2 = NPC(
        name="Dr. Siti",
        x=400,
        y=300,
        sprite_config=npc2_sprite_config,
        dialogue_lines=DOSEN_DIALOGUES["database"]
    )
    npcs.append(npc2)

    # CONTOH 3: NPC dengan fallback (kotak warna) - Color berbeda
    npc3_sprite_config = {
        'type': 'fallback',
        'color': (200, 100, 100),  # Merah
        'size': (48, 48)
    }

    npc3 = NPC(
        name="Pak Ahmad",
        x=600,
        y=200,
        sprite_config=npc3_sprite_config,
        dialogue_lines=DOSEN_DIALOGUES["jaringan"]
    )
    npcs.append(npc3)

    # CONTOH 4: NPC dengan fallback - Color berbeda
    npc4_sprite_config = {
        'type': 'fallback',
        'color': (100, 200, 100),  # Hijau
        'size': (48, 48)
    }

    npc4 = NPC(
        name="Bu Rina",
        x=300,
        y=450,
        sprite_config=npc4_sprite_config,
        dialogue_lines=DOSEN_DIALOGUES["matematika"]
    )
    npcs.append(npc4)

    # CONTOH 5: NPC dengan fallback default (biru)
    npc5_sprite_config = {
        'type': 'fallback',
        'color': (100, 100, 200),  # Biru (default)
        'size': (48, 48)
    }

    npc5 = NPC(
        name="Pak Dedi",
        x=150,
        y=350,
        sprite_config=npc5_sprite_config,
        dialogue_lines=DOSEN_DIALOGUES["umum"]
    )
    npcs.append(npc5)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ’¡ TIPS SPRITE CONFIG:
    #
    # 1. Aseprite Export:
    #    - File â†’ Export â†’ Export Sprite Sheet
    #    - Output: PNG + JSON
    #    - JSON Data: Array
    #    - Item Filename: {frame}
    #    - Beri tag pada animation (idle, walk, dll)
    #
    # 2. Simple Strip:
    #    - Buat sprite strip horizontal (semua frame berjajar)
    #    - Semua frame harus sama ukuran
    #    - Cocok untuk animasi sederhana
    #
    # 3. Fallback:
    #    - Akan otomatis digunakan jika file tidak ditemukan
    #    - Bisa custom warna dan ukuran
    #    - Bagus untuk prototyping
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â­ GENERATED NPCs - AUTO-CREATED
    # Generated: 2025-12-30 19:05:17
    # Total NPCs: 1
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # NPC 1: Pak Aldo - Dosen
    # Location: (4.768, 160.0)
    # Spawn key: npc_pak_aldo
    # Quest: Debug program yang error IndexError

    npc1_sprite = {
        'type': 'aseprite',
        'spritesheet': 'NPC/pakaldogerakan.png',
        'json': 'NPC/pakaldogerakan.json',
    }

    npc1_dialogues = [
        "Kerjakan tugas coding tentang algoritma sorting!",
        "Buat program kalkulator sederhana sebagai tugas!",
        "Debug code ini dan temukan errornya!",
        "Implementasikan struktur data linked list!",
        "Optimasi kode yang telah kamu buat!",
    ]

    npc1 = NPC(
        name="Pak Aldo",
        x=4.768,
        y=160.0,
        sprite_config=npc1_sprite,
        dialogue_lines=npc1_dialogues
    )
    npcs.append(npc1)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â­ GENERATED NPCs - AUTO-CREATED
    # Generated: 2025-12-30 19:10:24
    # Total NPCs: 1
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # NPC 1: Pak Aldo - Dosen
    # Location: (4768.0, 160.0)
    # Spawn key: npc_pak_aldo
    # Quest: Buat program sorting dengan algoritma bubble sort

    npc1_sprite = {
        'type': 'aseprite',
        'spritesheet': 'NPC/pakaldogerakan.png',
        'json': 'NPC/pakaldogerakan.json',
    }

    npc1_dialogues = [
        "Kerjakan tugas coding tentang algoritma sorting!",
        "Buat program kalkulator sederhana sebagai tugas!",
        "Debug code ini dan temukan errornya!",
        "Implementasikan struktur data linked list!",
        "Optimasi kode yang telah kamu buat!",
    ]

    npc1 = NPC(
        name="Pak Aldo",
        x=4768.0,
        y=160.0,
        sprite_config=npc1_sprite,
        dialogue_lines=npc1_dialogues
    )
    npcs.append(npc1)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•





    return npcs
